<!DOCTYPE html>
<html lang="en">
<head>
  <title>Snake</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">   
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery.js"></script>
  <script src="js/bootstrap.min.js"></script>
</head>
<body>
<style>
  html{
    --color-bg-1: #BCE8F0;
    --color-bg-2: #9BDCE9;
    --color-border-1: #4F8492;
    --color-border-2: #022B3A;
    --color-item-1: #6DA2B0;
    --color-text-1: #022B3A;
    --color-text-2: #044962;
    --color-text-3: #6DA2B0;
  }
  body{
    box-sizing: border-box;
    background-color: var(--color-bg-2);
  	color: var(--color-text-1);
    font-size: 15px;
  	font-family: Verdana, sans-serif;    
  }
  h1{
    border-bottom: 3px solid var(--color-border-1);
    color: var(--color-text-1);
    font-weight: bold;
    letter-spacing: 10px;
    margin-bottom: 30px;
    padding: 10px;
    text-align: center;
  }
  #description{
    margin-bottom: 40px;
  }
  p{
    line-height: 120%;
    text-align: justify;
  }
  .box-n-btn{
    border: 2px solid var(--color-border-1);
    border-radius: 10px;
    padding: 4px 9px 4px 9px;
  }
  .text-box{
    border: 3px solid var(--color-border-1);
    border-radius: 10px;
    background-color: var(--color-bg-1);
    color: var(--color-text-2);
    font-size: 0.8em;
    font-family: Verdana, sans-serif;
    overflow: auto;
    padding: -10px;
    /*padding: 4px 9px 4px 9px;*/
    resize: none;
    margin-bottom: 40px;
  }
  .text-box:focus{
    border-color: var(--color-border-1);
    box-shadow: 0px 0px 0px 0px #000;
  }
  .text-box::placeholder{
    color: var(--color-text-3);
  }
  .text-box:focus::placeholder{
    color: var(--color-text-3);
  }
  .function-button{
    background-color: var(--color-border-1);
    color: white;
    font-size: 1.2em;
    font-weight: bold;
    height: 40px;
    letter-spacing: 2px;
    margin-top: 10px;
  }
  .function-button:active{
    background-color: var(--color-item-1);
    border: 2px solid var(--color-item-1);
  }
</style>

<div id = "main-content" class = "container">
  <div class = "row">
    <h1 class = "col-sm-12">snake</h1>
    <div id = "description" class = "col-sm-10 col-sm-offset-1">
      <p>A classic snake game. Use the W, S, A, D keys to control the snake. For test purposes you can also press G to make the snake grow or press F to reposition the apple to a new random place. The site is not responsive, feel free to use the zoom funcion of the browser if it is too big or too small.</p>
      <p>Your score is: <span id = "sc">0</span></p>
    </div>
  </div>

  <div class = "row">
    <div class = "col-sm-12">
      <div class = "clearfix"></div>
      <canvas id = "canvas-box" class = "text-box" width = "1120" height = "440"></canvas> <!-- Canvas width and height should be dividable by 20 -->
    </div>

    <div class = "col-sm-12">
      <button type = "button" class = "box-n-btn function-button btn-block col-sm-12" onclick = "snakeGame()">start</button>
    </div>
  </div>
</div>

<script>  
  function snakeGame() {

    const canvas = document.getElementById("canvas-box");
    const ctx = canvas.getContext("2d");
    const ups = 20; // upscale for one pixel 
    const canvasRight = 1120 / ups;
    const canvasBottom = 440 / ups;

    const cycle = 5; // length of one cycle - can be used adjust speed of game. Min 2
    let tick = 0;

    let score = 0;
    document.getElementById('sc').innerHTML = score;

    // Snake
    let dirx = 1, diry = 0; // direction of snake movement
    let snake = [ [ 5, 5 ], [ 4, 5 ], [ 3, 5 ], [ 2, 5 ] ];

    const isHit = ([ x, y ], [ x2, y2 ]) => x === x2 && y === y2;
    const isHitBody = (coord) =>
      snake.some((sCoord) => isHit(sCoord, coord))

    const head = () => snake[0];
    const ghost = () => {
      const [ x, y ] = head();
      return [ x + dirx, y + diry ];
    };

    const checkHitSelf = () => {
      if (isHitBody(ghost())) gameOver('Hit self');
    };
    const checkHitWall = () => {
      const [ x, y ] = ghost();
      if (x === -1 || x === canvasRight || y === -1 || y === canvasBottom) gameOver('Hit wall');
    };
    
    // Apple
    let growth = 0; // Initial value of growth. Set to higher number after an apple is eaten.
    let apple = [ 12, 12 ];
    const newApple = () => {
      let regen = true;
      while (regen) {
        regen = false; 
        apple = [ Math.floor(Math.random() * canvasRight), Math.floor(Math.random() * canvasBottom) ]
        if(isHitBody(apple)) regen = true; // on snake, regenerate
      }
    };
    newApple();

    const handleKeyPress = (k) => {
      const prevDirX = dirx; // Stores the last direction before the keystroke.
      const prevDirY = diry;

      if (k.code === 'KeyW'){ // move up
        dirx = 0;
        diry = -1;
      }
      if (k.code === 'KeyS'){ // move down
        dirx = 0;
        diry = 1;
      }
      if (k.code === 'KeyA'){ // move left
        dirx = -1;
        diry = 0;
      }
      if (k.code === 'KeyD'){ // move right
        dirx = 1;
        diry = 0;
      }
      if (k.code === 'KeyG'){ // grow snake - for test purposes
        growth = 3;
      }
      if (k.code === 'KeyF'){ // place new apple - for test purposes
        newApple();
      }

      // If snake turns, turn immediately, to assist zig-zag movements
      // If a pressed key does not change direction, it won't step forward immediately to prevent jumping forward.
      if (prevDirX !== dirx && prevDirY !== diry){
        tick = cycle;
      }        
    };
    document.addEventListener('keydown', handleKeyPress);

    // Game loop
    const mainFn = () => {
      if (tick < cycle){
        tick++;
      } else { 
        // new cycle starts if direction is changed or we reach max ticks
        check180Turn();
        checkHitSelf();
        checkHitWall();
        checkApple();
        updateSnake();
        drawSnake();
        drawSq(apple, '#AD343E');
        tick = 0; // New cycle
      }
    };

    const game = setInterval(mainFn, 10);

    const checkApple = () => {
      if (isHit(ghost(), apple)){
        growth = 3;
        score++;
        document.getElementById('sc').innerHTML = score;
        newApple();        
        console.log("Apple eaten");
      }
    };

    const check180Turn = () => {
      if(isHit(ghost(),  snake[1])){
        const [ x, y ] = head();
        snake = [ [ x - 2 * dirX, y - 2 * dirY ], ...snake.shift() ] ;
      } 
    }; 

    const updateSnake = () => {
      if (growth > 0) {
        snake = [ ghost(), ...snake ];
        growth--;
      } else {
        snake = [ ghost(), ...snake.slice(0, -1) ];
      }
    };

    const drawSnake= () => {    
      clearCanvas();
      snake.forEach((coord) => drawSq(coord, '#4F8492'))
    };

    const drawSq = ([ x, y ], color) => {
      ctx.fillStyle = color;
      ctx.fillRect(x * ups, y * ups, ups, ups);
    };

    const gameOver = (reason) => {
      console.log(reason);
      alert("Game Over! Your final score is: " + score);
      clearInterval(game);     
      document.removeEventListener('keydown', handleKeyPress);
    };

    // Screen should be cleared before every new drawSn(). Input: width and height in coordinates.
    const clearCanvas = () => { 
      ctx.clearRect(0, 0, canvasRight * ups, canvasBottom * ups);
    };    
  };
</script>
</body>
</html>

<!-- browser-sync start --server --directory --files "**/*" -->
<!-- https://coolors.co/022b3a-044962-4f8492-6da2b0-218397-9bdce9-bce8f0 -->
